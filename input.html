<!DOCTYPE html>
<html>
<head>
  <title>The Traitors â€“ Input</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="panel" id="app"></div>

<script>
/* ================= STORAGE ================= */

function load() {
  return JSON.parse(localStorage.getItem("gameState"));
}
function save(s) {
  localStorage.setItem("gameState", JSON.stringify(s));
}

/* ================= SPEECH ================= */

function speak(text) {
  const u = new SpeechSynthesisUtterance(text);
  const voices = speechSynthesis.getVoices();
  u.voice = voices.find(v => v.name.toLowerCase().includes("female")) || voices[0];
  speechSynthesis.cancel();
  speechSynthesis.speak(u);
}

/* ================= HELPERS ================= */

function alivePlayers(s) {
  return s.players.filter(p => p.alive);
}

/* ================= INIT ================= */

function startGame() {
  const count = Number(document.getElementById("count").value);
  if (!count || count < 3) return;

  const players = [];
  for (let i = 1; i <= count; i++) {
    players.push({ id: i, name: "", role: "", alive: true });
  }

  save({
    phase: "SETUP",
    players,
    index: 0,
    murderVotes: [],
    selected: null,
    votes: {},
    timer: 0
  });
  render();
}

/* ================= RENDER ================= */

function render() {
  const app = document.getElementById("app");
  app.innerHTML = "";
  const s = load();

  /* START */
  if (!s) {
    app.innerHTML = `
      <img src="traitors.jpg" class="logo">
      <h2>START GAME</h2>
      <input id="count" type="number" min="3" placeholder="NUMBER OF PLAYERS">
      <button onclick="startGame()">START</button>
    `;
    return;
  }

  /* SETUP */
  if (s.phase === "SETUP") {
    const p = s.players[s.index];
    app.innerHTML = `
      <h2>PLAYER ${p.id}</h2>
      <input id="name" placeholder="NAME">
      <select id="role">
        <option value="">ROLE</option>
        <option value="FAITHFUL">FAITHFUL</option>
        <option value="TRAITOR">TRAITOR</option>
      </select>
      <button onclick="confirmSetup()">CONFIRM</button>
    `;
    return;
  }

  /* MENU */
  if (s.phase === "MENU") {
    app.innerHTML = `
      <h2>GAME MENU</h2>
      <button onclick="randomGame()">GAME</button>
      <button onclick="startBanish()">FINAL BANISHMENT</button>
    `;
    return;
  }

  /* MURDER */
  if (s.phase === "MURDER") {
    const alive = alivePlayers(s);
    const p = alive[s.index];

    app.innerHTML = `
      <h2>${p.name}</h2>
      <p>PLEASE TAKE YOUR SHOT</p>
    `;

    if (p.role !== "TRAITOR") {
      app.innerHTML += `
        <p>You are not a Traitor.<br>Please return to your seat.</p>
        <button onclick="recruit()">I HAVE BEEN RECRUITED</button>
        <button onclick="finishShot()">I'M DONE WITH MY SHOT</button>
      `;
      return;
    }

    app.innerHTML += `<p>SELECT A PLAYER TO MURDER</p>`;

    alive.filter(pl => pl.role !== "TRAITOR").forEach(pl => {
      const b = document.createElement("button");
      b.textContent = pl.name;
      if (s.selected === pl.id) b.classList.add("selected");
      b.onclick = () => {
        s.selected = pl.id;
        save(s);
        render();
      };
      app.appendChild(b);
    });

    app.innerHTML += `
      <br>
      <button onclick="confirmMurder()">I'M DONE WITH MY SHOT</button>
    `;
    return;
  }

  /* PASS */
  if (s.phase === "PASS") {
    app.innerHTML = `
      <h2>PASS THE DEVICE</h2>
      <button onclick="nextMurder()">NEXT PLAYER</button>
    `;
    return;
  }

  /* TALK */
  if (s.phase === "TALK") {
    app.innerHTML = `
      <h2>YOU HAVE 2 MINUTES TO TALK</h2>
      <h1>${formatTime(s.timer)}</h1>
    `;
    return;
  }

  /* BANISH */
  if (s.phase === "BANISH") {
    const alive = alivePlayers(s);
    const p = alive[s.index];

    app.innerHTML = `
      <h2>${p.name}</h2>
      <p>WHO SHOULD BE BANISHED?</p>
    `;

    alive.forEach(pl => {
      const b = document.createElement("button");
      b.textContent = pl.name.toUpperCase();
      b.onclick = () => castVote(pl.name.toUpperCase());
      app.appendChild(b);
    });
  }
}

/* ================= SETUP ================= */

function confirmSetup() {
  const s = load();
  const p = s.players[s.index];
  p.name = document.getElementById("name").value.trim();
  p.role = document.getElementById("role").value;
  if (!p.name || !p.role) return;

  s.index++;
  if (s.index >= s.players.length) {
    s.phase = "MENU";
    s.index = 0;
  }
  save(s);
  render();
}

/* ================= GAME ================= */

function randomGame() {
  const r = Math.floor(Math.random() * 3);
  if (r === 0) {
    speak("Silent night. Nothing happens.");
    return;
  }
  if (r === 1) startMurder();
  if (r === 2) startBanish();
}

function startMurder() {
  const s = load();
  s.phase = "MURDER";
  s.index = 0;
  s.murderVotes = [];
  s.selected = null;
  speak("Heads down.");
  save(s);
  render();
}

function confirmMurder() {
  const s = load();
  if (s.selected) s.murderVotes.push(s.selected);
  s.selected = null;
  s.phase = "PASS";
  save(s);
  render();
}

function finishShot() {
  const s = load();
  s.phase = "PASS";
  save(s);
  render();
}

function nextMurder() {
  const s = load();
  s.index++;
  if (s.index >= alivePlayers(s).length) return resolveMurder();
  s.phase = "MURDER";
  save(s);
  render();
}

function resolveMurder() {
  const s = load();
  if (s.murderVotes.length > 0) {
    const victimId =
      s.murderVotes[Math.floor(Math.random() * s.murderVotes.length)];
    const v = s.players.find(p => p.id === victimId);
    v.alive = false;
    speak(`${v.name} has been murdered`);
  }
  s.phase = "MENU";
  s.index = 0;
  save(s);
  render();
}

function recruit() {
  const s = load();
  const alive = alivePlayers(s);
  alive[s.index].role = "TRAITOR";
  speak("You have been recruited");
  save(s);
  render();
}

/* ================= BANISH ================= */

function startBanish() {
  const s = load();
  s.phase = "TALK";
  s.timer = 120;
  s.votes = {};
  save(s);
  render();

  const t = setInterval(() => {
    const st = load();
    st.timer--;
    save(st);
    render();
    if (st.timer <= 0) {
      clearInterval(t);
      st.phase = "BANISH";
      st.index = 0;
      speak("Heads down.");
      save(st);
      render();
    }
  }, 1000);
}

function castVote(name) {
  const s = load();
  s.votes[name] = (s.votes[name] || 0) + 1;
  s.index++;

  if (s.index >= alivePlayers(s).length) return resolveVote();
  save(s);
  render();
}

function resolveVote() {
  const s = load();
  const entries = Object.entries(s.votes);
  const max = Math.max(...entries.map(e => e[1]));
  const top = entries.filter(e => e[1] === max);

  if (top.length > 1) {
    s.votes = {};
    s.index = 0;
    speak("There has been a tie. Vote again.");
    save(s);
    render();
    return;
  }

  const banished = s.players.find(
    p => p.name.toUpperCase() === top[0][0]
  );
  banished.alive = false;
  speak(`${banished.name} has been banished`);
  s.phase = "MENU";
  s.index = 0;
  save(s);
  render();
}

/* ================= UTIL ================= */

function formatTime(t) {
  const m = Math.floor(t / 60);
  const s = t % 60;
  return `${m}:${s.toString().padStart(2, "0")}`;
}

window.addEventListener("storage", render);
render();
</script>

</body>
</html>
