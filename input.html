<!DOCTYPE html>
<html>
<head>
  <title>The Traitors â€“ Input</title>
  <link rel="stylesheet" href="style.css">
  <script src="game.js"></script>
</head>
<body>

<div class="panel" id="ui"></div>

<script>
function render() {
  const s = load();
  const ui = document.getElementById("ui");
  ui.innerHTML = "";

  if (!s || !s.adminConfirmed || s.paused) {
    ui.innerHTML = `<img src="traitors.jpg" class="logo">`;
    return;
  }

  /* PLAYER SETUP */
  if (s.phase === "SETUP") {
    const p = s.players.find(pl => !pl.name);
    if (!p) {
      s.phase = "MENU";
      save(s);
      render();
      return;
    }

    ui.innerHTML = `
      <h2>PLAYER ${p.id}</h2>
      <input id="name" placeholder="NAME">
      <select id="role">
        <option value="FAITHFUL">FAITHFUL</option>
        <option value="TRAITOR">TRAITOR</option>
      </select>
      <br>
      <button onclick="confirmPlayer(${p.id})">CONFIRM</button>
    `;
    return;
  }

  /* MENU */
  if (s.phase === "MENU") {
    ui.innerHTML = `
      <h2>CHOOSE PHASE</h2>
      <button onclick="startGame()">GAME</button>
      <button onclick="startFinalBanish()">FINAL BANISHMENT</button>
    `;
    return;
  }

  /* MURDER */
  if (s.phase === "MURDER") {
    const p = s.players.find(pl => pl.id === s.currentPlayer);
    ui.innerHTML = `<h2>${p.name}</h2>`;

    if (p.role !== "TRAITOR") {
      ui.innerHTML += `<p>YOU ARE FAITHFUL<br>NO ACTION REQUIRED<br>PLEASE RETURN TO YOUR SEAT</p>`;
      ui.innerHTML += `<button onclick="nextMurder()">CONTINUE</button>`;
      return;
    }

    ui.innerHTML += `<p>SELECT A PLAYER TO MURDER</p>`;
    s.players
      .filter(pl => pl.alive && pl.role === "FAITHFUL")
      .forEach(pl => {
        const b = document.createElement("button");
        b.textContent = pl.name;
        b.onclick = () => chooseMurder(pl.id);
        ui.appendChild(b);
      });
    return;
  }

  /* TALKING */
  if (s.phase === "TALK") {
    ui.innerHTML = `
      <h2>YOU HAVE 2 MINUTES TO TALK</h2>
      <div id="countdown">${s.timer}</div>
    `;
    return;
  }

  /* BANISHMENT */
  if (s.phase === "BANISH") {
    const p = s.players.find(pl => pl.id === s.currentPlayer);
    ui.innerHTML = `<h2>${p.name}</h2><p>WHO SHOULD BE BANISHED?</p>`;

    s.players.filter(pl => pl.alive).forEach(pl => {
      const b = document.createElement("button");
      b.textContent = pl.name.toUpperCase();
      b.onclick = () => vote(pl.name.toUpperCase());
      ui.appendChild(b);
    });
  }
}

/* === FUNCTIONS === */

function confirmPlayer(id) {
  const s = load();
  s.players.find(p => p.id === id).name = document.getElementById("name").value.trim();
  s.players.find(p => p.id === id).role = document.getElementById("role").value;
  save(s); render();
}

function startGame() {
  const s = load();
  const roll = Math.floor(Math.random() * 3);
  if (roll === 0) {
    speak("Silent night. Nothing happens.");
    return;
  }
  if (roll === 1) startMurder();
  if (roll === 2) startBanish();
}

function startMurder() {
  const s = load();
  s.phase = "MURDER";
  s.murderChoices = [];
  s.currentPlayer = s.players.find(p => p.alive).id;
  speak("Heads down.");
  save(s); render();
}

function chooseMurder(id) {
  const s = load();
  s.murderChoices.push(id);
  nextMurder();
}

function nextMurder() {
  const s = load();
  const alive = s.players.filter(p => p.alive);
  const idx = alive.findIndex(p => p.id === s.currentPlayer);
  if (idx + 1 >= alive.length) return resolveMurder();
  s.currentPlayer = alive[idx + 1].id;
  save(s); render();
}

function resolveMurder() {
  const s = load();
  if (s.murderChoices.length) {
    const id = s.murderChoices[Math.floor(Math.random() * s.murderChoices.length)];
    s.players.find(p => p.id === id).alive = false;
    speak("Players, the night is over.");
  }
  s.phase = "MENU";
  save(s); render();
}

function startBanish() {
  const s = load();
  s.phase = "TALK";
  s.timer = 120;
  save(s);
  const interval = setInterval(() => {
    const st = load();
    st.timer--;
    save(st);
    if (st.timer <= 0) {
      clearInterval(interval);
      st.phase = "BANISH";
      st.currentPlayer = st.players.find(p => p.alive).id;
      save(st);
    }
    render();
  }, 1000);
}

function vote(name) {
  const s = load();
  s.votes = s.votes || {};
  s.votes[name] = (s.votes[name] || 0) + 1;
  const alive = s.players.filter(p => p.alive);
  const idx = alive.findIndex(p => p.id === s.currentPlayer);
  if (idx + 1 >= alive.length) return resolveVote();
  s.currentPlayer = alive[idx + 1].id;
  save(s); render();
}

function resolveVote() {
  const s = load();
  const entries = Object.entries(s.votes);
  const max = Math.max(...entries.map(e => e[1]));
  const top = entries.filter(e => e[1] === max);
  if (top.length > 1) {
    s.votes = {};
    s.currentPlayer = s.players.find(p => p.alive).id;
    save(s); render();
    return;
  }
  s.players.find(p => p.name.toUpperCase() === top[0][0]).alive = false;
  s.phase = "MENU";
  save(s); render();
}

window.addEventListener("storage", render);
render();
</script>

</body>
</html>
