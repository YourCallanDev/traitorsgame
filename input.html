<!DOCTYPE html>
<html>
<head>
  <title>The Traitors – Input</title>
  <link rel="stylesheet" href="style.css">
  <script src="game.js"></script>
</head>
<body>

<div class="panel" id="ui"></div>

<script>
function setDisplay(text) {
  const s = load();
  s.displayText = text;
  save(s);
}

function render() {
  const s = load();
  const ui = document.getElementById("ui");
  ui.innerHTML = "";

  if (!s) {
    ui.innerHTML = `
      <img src="traitors.jpg" class="logo">
      <h2>START GAME</h2>
      <input id="count" type="number" min="3" placeholder="Number of Players">
      <button onclick="start()">START</button>
    `;
    return;
  }

  if (s.paused) {
    ui.innerHTML = `<img src="traitors.jpg" class="logo"><h2>GAME PAUSED</h2>`;
    return;
  }

  /* SETUP */
  if (s.phase === "SETUP") {
    const p = s.players.find(pl => !pl.name);
    if (!p) {
      s.phase = "MENU";
      save(s); render(); return;
    }
    ui.innerHTML = `
      <h2>PLAYER ${p.id}</h2>
      <input id="name" placeholder="NAME">
      <select id="role">
        <option value="FAITHFUL">FAITHFUL</option>
        <option value="TRAITOR">TRAITOR</option>
      </select>
      <button onclick="confirm(${p.id})">CONFIRM</button>
    `;
    return;
  }

  /* MENU */
  if (s.phase === "MENU") {
    ui.innerHTML = `
      <h2>CHOOSE PHASE</h2>
      <button onclick="game()">GAME</button>
      <button onclick="finalBanish()">FINAL BANISHMENT</button>
    `;
    return;
  }

  /* MURDER – CALL */
  if (s.phase === "MURDER_CALL") {
    const p = s.players.find(pl => pl.id === s.current);
    ui.innerHTML = `
      <h2>PLAYER ${p.id}</h2>
      <p>PLEASE COME TO THE COMPUTER</p>
      <button onclick="startShot()">START MY SHOT</button>
    `;
    return;
  }

  /* MURDER – ACTION */
  if (s.phase === "MURDER_ACTION") {
    const p = s.players.find(pl => pl.id === s.current);
    ui.innerHTML = `<h2>${p.name}</h2>`;

    ui.innerHTML += `<p>SELECT A PLAYER TO MURDER (OR NONE)</p>`;
    s.players
      .filter(pl => pl.alive && pl.id !== p.id && pl.role !== "TRAITOR")
      .forEach(pl => {
        const b = document.createElement("button");
        b.textContent = pl.name;
        b.onclick = () => murder(pl.id);
        ui.appendChild(b);
      });

    ui.innerHTML += `
      <br>
      <button onclick="recruit()">I'VE BEEN RECRUITED</button>
      <br>
      <button onclick="doneShot()">I'M DONE WITH MY SHOT</button>
    `;
    return;
  }

  /* PRIVACY SCREEN */
  if (s.phase === "NEXT_SHOT") {
    ui.innerHTML = `
      <h2>NEXT SHOT</h2>
      <button onclick="nextMurder()">CONTINUE</button>
    `;
    return;
  }

  /* TALK */
  if (s.phase === "TALK") {
    ui.innerHTML = `
      <h2>YOU HAVE 2 MINUTES TO TALK</h2>
      <div id="countdown">${formatTime(s.timer)}</div>
    `;
    return;
  }

  /* BANISH */
  if (s.phase === "BANISH") {
    const p = s.players.find(pl => pl.id === s.current);
    ui.innerHTML = `<h2>${p.name}</h2><p>WHO SHOULD BE BANISHED?</p>`;

    s.players.filter(pl => pl.alive).forEach(pl => {
      const b = document.createElement("button");
      b.textContent = pl.name.toUpperCase();
      b.onclick = () => vote(pl.name.toUpperCase());
      ui.appendChild(b);
    });

    ui.innerHTML += `
      <br>
      <button onclick="recruit()">I'VE BEEN RECRUITED</button>
    `;
  }
}

/* ===== GAME LOGIC ===== */

function start() {
  const n = Number(document.getElementById("count").value);
  if (n < 3) return;
  initGame(n, true);
  render();
}

function confirm(id) {
  const s = load();
  const p = s.players.find(pl => pl.id === id);
  p.name = document.getElementById("name").value.trim();
  p.role = document.getElementById("role").value;
  save(s); render();
}

function game() {
  const r = Math.floor(Math.random() * 3);
  if (r === 0) { speak("Silent night. Nothing happens."); return; }
  if (r === 1) startMurder();
  if (r === 2) startBanish();
}

/* ===== MURDER ===== */

function startMurder() {
  const s = load();
  s.phase = "MURDER_CALL";
  s.murderChoices = [];
  s.current = s.players.find(p => p.alive).id;
  setDisplay(`PLAYER ${s.current} PLEASE COME TO THE COMPUTER`);
  speak(`Player ${s.current}, please come to the computer.`);
  save(s); render();
}

function startShot() {
  const s = load();
  s.phase = "MURDER_ACTION";
  save(s); render();
}

function murder(id) {
  const s = load();
  s.murderChoices.push(id);
}

function recruit() {
  const s = load();
  s.players.find(p => p.id === s.current).role = "TRAITOR";
  save(s); render();
}

function doneShot() {
  const s = load();
  s.phase = "NEXT_SHOT";
  save(s); render();
}

function nextMurder() {
  const s = load();
  const alive = s.players.filter(p => p.alive);
  const i = alive.findIndex(p => p.id === s.current);
  if (i + 1 >= alive.length) return resolveMurder();
  s.current = alive[i + 1].id;
  s.phase = "MURDER_CALL";
  setDisplay(`PLAYER ${s.current} PLEASE COME TO THE COMPUTER`);
  speak(`Player ${s.current}, please come to the computer.`);
  save(s); render();
}

function resolveMurder() {
  const s = load();
  if (s.murderChoices.length) {
    const id = s.murderChoices[Math.floor(Math.random() * s.murderChoices.length)];
    s.players.find(p => p.id === id).alive = false;
    speak("Players, the night is over.");
  }
  s.phase = "MENU";
  setDisplay("CHOOSE THE NEXT PHASE");
  save(s); render();
}

/* ===== BANISH ===== */

function startBanish() {
  const s = load();
  s.phase = "TALK";
  s.timer = 120;
  setDisplay("YOU HAVE 2 MINUTES TO TALK");
  save(s);

  const t = setInterval(() => {
    const st = load();
    st.timer--;
    save(st);
    render();
    if (st.timer <= 0) {
      clearInterval(t);
      st.phase = "BANISH";
      st.current = st.players.find(p => p.alive).id;
      setDisplay("HEADS DOWN");
      save(st);
      render();
    }
  }, 1000);
}

function vote(name) {
  const s = load();
  s.votes = s.votes || {};
  s.votes[name] = (s.votes[name] || 0) + 1;

  const alive = s.players.filter(p => p.alive);
  const i = alive.findIndex(p => p.id === s.current);
  if (i + 1 >= alive.length) return resolveVote();
  s.current = alive[i + 1].id;
  save(s); render();
}

function resolveVote() {
  const s = load();
  const e = Object.entries(s.votes);
  const max = Math.max(...e.map(v => v[1]));
  const top = e.filter(v => v[1] === max);
  if (top.length > 1) {
    s.votes = {};
    s.current = s.players.find(p => p.alive).id;
    save(s); render();
    return;
  }
  s.players.find(p => p.name.toUpperCase() === top[0][0]).alive = false;
  s.phase = "MENU";
  setDisplay("CHOOSE THE NEXT PHASE");
  save(s); render();
}

function finalBanish() { startBanish(); }

function formatTime(t) {
  return `${Math.floor(t/60)}:${String(t%60).padStart(2,"0")}`;
}

window.addEventListener("storage", render);
render();
</script>

</body>
</html>
