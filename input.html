<!DOCTYPE html>
<html>
<head>
  <title>The Traitors â€“ Input</title>
  <link rel="stylesheet" href="style.css">
  <script src="game.js"></script>
</head>

<body>
<div class="panel" id="ui"></div>

<script>
/* ================== HELPERS ================== */

function femaleSpeak(text) {
  const u = new SpeechSynthesisUtterance(text);
  const voices = speechSynthesis.getVoices();
  const female = voices.find(v => v.name.toLowerCase().includes("female")) || voices[0];
  u.voice = female;
  speechSynthesis.speak(u);
}

function alivePlayers(s) {
  return s.players.filter(p => p.alive);
}

/* ================== RENDER ================== */

function render() {
  const s = load();
  const ui = document.getElementById("ui");
  ui.innerHTML = "";

  /* NO GAME */
  if (!s) {
    ui.innerHTML = `
      <img src="traitors.jpg" class="logo">
      <h2>START GAME</h2>
      <input id="count" type="number" min="3" placeholder="NUMBER OF PLAYERS">
      <button onclick="startGame()">START</button>
    `;
    return;
  }

  /* SETUP */
  if (s.phase === "SETUP") {
    const p = s.players.find(pl => !pl.name);
    if (!p) {
      s.phase = "MENU";
      save(s); render(); return;
    }

    ui.innerHTML = `
      <h2>PLAYER ${p.id}</h2>
      <input id="name" placeholder="PLAYER NAME">
      <select id="role">
        <option value="FAITHFUL">FAITHFUL</option>
        <option value="TRAITOR">TRAITOR</option>
      </select>
      <button onclick="confirmPlayer(${p.id})">CONFIRM</button>
    `;
    return;
  }

  /* MENU */
  if (s.phase === "MENU") {
    ui.innerHTML = `
      <h2>CHOOSE PHASE</h2>
      <button onclick="startGamePhase()">GAME</button>
      <button onclick="startFinalBanish()">FINAL BANISHMENT</button>
    `;
    return;
  }

  /* MURDER TURN */
  if (s.phase === "MURDER") {
    const p = s.players.find(pl => pl.id === s.current);

    setDisplay(`PLAYER ${p.id}, PLEASE COME TO THE COMPUTER`);

    ui.innerHTML = `
      <h2>${p.name}</h2>
      <p>PLAYER ${p.id}, IT IS YOUR SHOT</p>
    `;

    if (p.role !== "TRAITOR") {
      ui.innerHTML += `
        <p>You are not a Traitor.<br>Please return to your seat.</p>
        <button onclick="finishShot()">I'M DONE WITH MY SHOT</button>
      `;
      return;
    }

    ui.innerHTML += `<p>SELECT A PLAYER TO MURDER</p>`;

    alivePlayers(s)
      .filter(pl => pl.role !== "TRAITOR")
      .forEach(pl => {
        const b = document.createElement("button");
        b.textContent = pl.name;
        b.className = "murder-option";
        if (s.selected === pl.id) b.classList.add("selected");
        b.onclick = () => {
          s.selected = pl.id;
          save(s); render();
        };
        ui.appendChild(b);
      });

    ui.innerHTML += `
      <br>
      <button onclick="recruit()">I'VE BEEN RECRUITED</button>
      <button onclick="confirmMurder()">I'M DONE WITH MY SHOT</button>
    `;
    return;
  }

  /* NEXT SHOT */
  if (s.phase === "NEXT_SHOT") {
    ui.innerHTML = `
      <h2>PASS THE DEVICE</h2>
      <button onclick="nextMurder()">NEXT SHOT</button>
    `;
    return;
  }

  /* TALK */
  if (s.phase === "TALK") {
    setDisplay("YOU HAVE 2 MINUTES TO TALK");
    ui.innerHTML = `
      <h2>DISCUSSION</h2>
      <div style="font-size:48px">${formatTime(s.timer)}</div>
    `;
    return;
  }

  /* BANISH */
  if (s.phase === "BANISH") {
    const p = s.players.find(pl => pl.id === s.current);
    setDisplay(`PLAYER ${p.id}, PLEASE VOTE`);

    ui.innerHTML = `
      <h2>${p.name}</h2>
      <p>WHO SHOULD BE BANISHED?</p>
    `;

    alivePlayers(s).forEach(pl => {
      const b = document.createElement("button");
      b.textContent = pl.name.toUpperCase();
      b.onclick = () => vote(pl.name.toUpperCase());
      ui.appendChild(b);
    });
  }
}

/* ================== ACTIONS ================== */

function startGame() {
  const n = Number(document.getElementById("count").value);
  if (!n || n < 3) return;
  initGame(n, true);
  render();
}

function confirmPlayer(id) {
  const s = load();
  const p = s.players.find(pl => pl.id === id);
  p.name = document.getElementById("name").value.trim();
  p.role = document.getElementById("role").value;
  save(s); render();
}

function startGamePhase() {
  const r = Math.floor(Math.random() * 3);
  if (r === 0) {
    femaleSpeak("Silent night. Nothing happens.");
    setDisplay("SILENT NIGHT");
    return;
  }
  if (r === 1) startMurder();
  if (r === 2) startBanish();
}

function startMurder() {
  const s = load();
  s.phase = "MURDER";
  s.murderChoices = [];
  s.selected = null;
  s.current = alivePlayers(s)[0].id;
  femaleSpeak("Heads down.");
  save(s); render();
}

function confirmMurder() {
  const s = load();
  if (s.selected) s.murderChoices.push(s.selected);
  s.selected = null;
  s.phase = "NEXT_SHOT";
  save(s); render();
}

function finishShot() {
  const s = load();
  s.phase = "NEXT_SHOT";
  save(s); render();
}

function nextMurder() {
  const s = load();
  const alive = alivePlayers(s);
  const i = alive.findIndex(p => p.id === s.current);
  if (i + 1 >= alive.length) return resolveMurder();
  s.current = alive[i + 1].id;
  s.phase = "MURDER";
  save(s); render();
}

function resolveMurder() {
  const s = load();
  if (s.murderChoices.length) {
    const id = s.murderChoices[Math.floor(Math.random() * s.murderChoices.length)];
    const v = s.players.find(p => p.id === id);
    v.alive = false;
    femaleSpeak(`${v.name} has been murdered`);
    setDisplay(`${v.name.toUpperCase()} HAS BEEN MURDERED`);
  }
  s.phase = "MENU";
  save(s); render();
}

function recruit() {
  const s = load();
  const p = s.players.find(pl => pl.id === s.current);
  p.role = "TRAITOR";
  femaleSpeak(`${p.name} has been recruited`);
  save(s); render();
}

function startBanish() {
  const s = load();
  s.phase = "TALK";
  s.timer = 120;
  save(s);

  const t = setInterval(() => {
    const st = load();
    st.timer--;
    save(st); render();
    if (st.timer <= 0) {
      clearInterval(t);
      st.phase = "BANISH";
      st.votes = {};
      st.current = alivePlayers(st)[0].id;
      femaleSpeak("Heads down.");
      save(st); render();
    }
  }, 1000);
}

function vote(name) {
  const s = load();
  s.votes[name] = (s.votes[name] || 0) + 1;
  const alive = alivePlayers(s);
  const i = alive.findIndex(p => p.id === s.current);
  if (i + 1 >= alive.length) return resolveVote();
  s.current = alive[i + 1].id;
  save(s); render();
}

function resolveVote() {
  const s = load();
  const entries = Object.entries(s.votes);
  const max = Math.max(...entries.map(e => e[1]));
  const top = entries.filter(e => e[1] === max);
  if (top.length > 1) {
    s.votes = {};
    s.current = alivePlayers(s)[0].id;
    femaleSpeak("There has been a tie. Vote again.");
    save(s); render();
    return;
  }
  const banished = s.players.find(p => p.name.toUpperCase() === top[0][0]);
  banished.alive = false;
  femaleSpeak(`${banished.name} has been banished`);
  setDisplay(`${banished.name.toUpperCase()} HAS BEEN BANISHED`);
  s.phase = "MENU";
  save(s); render();
}

function startFinalBanish() {
  startBanish();
}

function formatTime(t) {
  const m = Math.floor(t / 60);
  const s = t % 60;
  return `${m}:${s.toString().padStart(2, "0")}`;
}

window.addEventListener("storage", render);
render();
</script>
</body>
</html>
