<!DOCTYPE html>
<html>
<head>
  <title>Traitors – Input</title>
  <link rel="stylesheet" href="style.css">
  <script src="game.js"></script>
</head>
<body>

<div class="panel fade" id="ui"></div>

<script>
let typing = false;

/* ================= RENDER ================= */
function render() {
  if (typing) return;
  const s = load();
  const ui = document.getElementById("ui");
  ui.innerHTML = "";

  if (!s) {
    ui.innerHTML = `
      <h2>Start Game</h2>
      <input id="count" type="number" min="3" placeholder="Players">
      <label><input type="checkbox" id="disp" checked> Use Display</label>
      <button onclick="init()">START</button>`;
    return;
  }

  if (!s.adminConfirmed) {
    ui.innerHTML = `<h2>Waiting for admin…</h2>`;
    return;
  }

  if (s.paused) {
    ui.innerHTML = `<h2>GAME PAUSED</h2>`;
    return;
  }

  /* SETUP */
  if (s.phase === "SETUP") {
    const p = s.players.find(pl => !pl.name);
    ui.innerHTML = `
      <h2>PLAYER ${p.id}</h2>
      <input id="name" placeholder="Name">
      <select id="role">
        <option>FAITHFUL</option>
        <option>TRAITOR</option>
      </select>
      <button onclick="savePlayer(${p.id})">CONFIRM</button>`;
    document.getElementById("name").onfocus = () => typing = true;
    document.getElementById("name").onblur = () => typing = false;
    return;
  }

  /* MENU */
  if (s.phase === "MENU") {
    ui.innerHTML = `
      <h2>Choose Phase</h2>
      <button onclick="game()">GAME</button>
      <button onclick="startBanish()">FINAL BANISHMENT</button>`;
    return;
  }

  /* BANISHMENT VOTING */
  if (s.phase === "BANISH_VOTE") {
    const me = s.players.find(p => p.id === s.currentPlayer);
    ui.innerHTML = `<h2>${me.name}, VOTE</h2>`;
    s.players.filter(p => p.alive).forEach(p => {
      const b = document.createElement("button");
      b.textContent = p.name.toUpperCase();
      b.onclick = () => vote(p.name);
      ui.appendChild(b);
    });
  }
}

/* ================= SETUP ================= */
function init() {
  initGame(+count.value, disp.checked);
  render();
}

function savePlayer(id) {
  const s = load();
  const p = s.players.find(x => x.id === id);
  p.name = name.value.trim();
  p.role = role.value;
  if (s.players.every(pl => pl.name)) {
    s.phase = "MENU";
    s.message = "CHOOSE THE NEXT PHASE";
    speak(s.message);
  }
  save(s); typing = false; render();
}

/* ================= GAME ================= */
function game() {
  const s = load();
  const roll = Math.floor(Math.random()*3);
  if (roll === 0) {
    s.message = "SILENT NIGHT";
    speak("Silent night");
    save(s);
    setTimeout(()=>{s.message="CHOOSE THE NEXT PHASE";save(s)},3000);
  }
  if (roll === 1) startMurder();
  if (roll === 2) startBanish();
}

/* ================= BANISHMENT ================= */
function startBanish() {
  const s = load();
  s.phase = "BANISH_TALK";
  s.banishVotes = {};
  s.message = "YOU HAVE 2 MINUTES TO TALK";
  save(s);
  speak(s.message);

  let time = 120;
  const tick = setInterval(() => {
    s.message = `TALKING TIME\n${Math.floor(time/60)}:${String(time%60).padStart(2,'0')}`;
    save(s);
    time--;
    if (time < 0) {
      clearInterval(tick);
      beginVoting();
    }
  },1000);
}

function beginVoting() {
  const s = load();
  s.phase = "BANISH_VOTE";
  s.currentPlayer = nextAlive(null);
  s.message = "HEADS DOWN";
  speak("Heads down");
  save(s);
}

function vote(name) {
  const s = load();
  s.banishVotes[name] = (s.banishVotes[name]||0)+1;
  s.currentPlayer = nextAlive(s.currentPlayer);
  if (!s.currentPlayer) resolveBanish();
  save(s);
}

function resolveBanish() {
  const s = load();
  const entries = Object.entries(s.banishVotes);
  const max = Math.max(...entries.map(e=>e[1]));
  const top = entries.filter(e=>e[1]===max);
  if (top.length>1) {
    s.banishVotes = {};
    beginVoting();
    return;
  }
  const banned = s.players.find(p=>p.name===top[0][0]);
  banned.alive=false;
  s.message = `${banned.name} HAS BEEN BANISHED\nPLEASE SAY YOUR ROLE`;
  speak(s.message);
  s.phase="MENU";
  save(s);
  checkWin();
}

/* ================= HELPERS ================= */
function nextAlive(id){
  const s=load();
  const alive=s.players.filter(p=>p.alive);
  if(!id) return alive[0]?.id;
  const i=alive.findIndex(p=>p.id===id);
  return alive[i+1]?.id;
}

window.addEventListener("storage",render);
render();
</script>
</body>
</html>
